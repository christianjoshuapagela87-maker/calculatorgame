<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time Bomb ‚Äî Math Defuse Game</title>
<style>
  :root{
    --bg:#07050a;
    --panel:#121015;
    --accent:#ff6b6b;
    --accent2:#ffd166;
    --glow:#00ffe9;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(circle at 20% 20%, #0d0b10 0%, var(--bg) 35%),
    linear-gradient(180deg, #040305, #08070a 100%);
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
    color:#e6edf3;
    -webkit-font-smoothing:antialiased;
  }

  .stage {
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    perspective:1400px;
    padding:20px;
    box-sizing:border-box;
  }

  /* Bomb panel scene */
  .scene {
    width:360px;
    max-width:92vw;
    transform-style:preserve-3d;
    transition:transform 0.12s ease-out;
  }

  .panel {
    background: linear-gradient(180deg, #1c1a1f, #0f0e12);
    border-radius:18px;
    padding:18px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 2px 12px rgba(255,255,255,0.02);
    transform: translateZ(60px);
    position:relative;
    overflow:hidden;
    user-select:none;
  }

  /* top status row */
  .topbar {
    display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px;
  }
  .timer {
    background:linear-gradient(180deg,#20090a,#2d0f11);
    padding:10px 14px;border-radius:10px;font-weight:700;font-size:20px;
    color:var(--accent); box-shadow:0 6px 18px rgba(255,107,107,0.12), inset 0 -2px 8px rgba(0,0,0,0.6);
  }
  .stage-info {font-size:13px;opacity:0.9;}

  /* bomb graphics */
  .bomb-wrap{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
  .bomb {
    width:120px;height:120px;border-radius:50%;
    background:radial-gradient(circle at 28% 30%, #3b0b0b 0%, #140304 40%, #000 100%);
    box-shadow:0 20px 60px rgba(255,20,20,0.06), inset 0 14px 40px rgba(255,255,255,0.03);
    display:flex;align-items:center;justify-content:center;position:relative;
    transform: translateZ(40px);
  }
  .bomb::after{
    content:"";position:absolute;left:12px;top:12px;width:12px;height:12px;border-radius:50%;
    background:radial-gradient(circle,#ffef8a,#ffb86b);box-shadow:0 0 24px 6px rgba(255,184,107,0.16);
  }
  .wires {flex:1;display:flex;flex-direction:column;gap:6px;padding-right:6px;}
  .wire {height:10px;border-radius:8px;background:linear-gradient(90deg,#2b2b2b,#050505);display:flex;align-items:center;padding:4px 8px;gap:8px;}
  .wire .dot{width:18px;height:18px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,0.6);background:#222;}

  /* question card */
  .card {
    margin-bottom:12px;
    background:linear-gradient(180deg,#0b0b0d,#0b0c0f);
    border-radius:12px;padding:14px;box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    transform: translateZ(40px);
  }
  .question {
    font-size:18px;font-weight:700;margin-bottom:6px;
    display:flex;align-items:center;gap:10px;justify-content:center;
  }
  .hint {font-size:12px;opacity:0.75;text-align:center;margin-bottom:8px;}

  /* input keypad */
  .pad {
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:8px;
    transform: translateZ(30px);
  }
  .btn {
    background:linear-gradient(180deg,#111,#0b0b0b);
    border-radius:10px;padding:14px;font-size:18px;font-weight:700;color:var(--glow);
    border:1px solid rgba(255,255,255,0.02);text-align:center;box-shadow:0 6px 18px rgba(0,0,0,0.7);
    touch-action: manipulation;
  }
  .btn:active{transform:translateY(2px) scale(0.995)}
  .wide{grid-column:span 3;background:linear-gradient(180deg,#2a0a0a,#3a0b0b);color:var(--accent2)}

  /* answer display */
  .answer {
    margin-top:10px;text-align:center;font-size:20px;padding:8px;background:linear-gradient(180deg,#050506,#0c0b0d);border-radius:8px;
    box-shadow:inset 0 -2px 8px rgba(0,0,0,0.5);min-height:36px;
  }

  /* overlay messages */
  .overlay {
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,0.35),rgba(0,0,0,0.6));backdrop-filter: blur(3px);
    opacity:0;pointer-events:none;transition:0.25s;
  }
  .overlay.show{opacity:1;pointer-events:auto;}
  .msg {
    background:linear-gradient(180deg,#041018,#07343b);
    padding:18px 26px;border-radius:12px;text-align:center;box-shadow:0 18px 50px rgba(0,0,0,0.7);
  }
  .boom {
    color:#ff8a8a;font-weight:900;font-size:30px;margin-bottom:12px;
    text-shadow:0 6px 22px rgba(255,106,106,0.25);
  }
  .defused {
    color:#8bffd2;font-weight:900;font-size:28px;margin-bottom:12px;
    text-shadow:0 6px 22px rgba(139,255,210,0.14);
  }

  /* small responsive */
  @media (max-width:420px){
    .bomb{width:96px;height:96px}
    .scene{width:320px}
  }
</style>
</head>
<body>
<div class="stage">
  <div class="scene" id="scene">
    <div class="panel" id="panel">
      <div class="topbar">
        <div class="timer" id="timer">00:30</div>
        <div class="stage-info">
          Stage <span id="stage-num">1</span> &nbsp; ‚Ä¢ &nbsp; Strikes <span id="strikes">0</span>/<span id="strikes-max">3</span>
        </div>
      </div>

      <div class="bomb-wrap">
        <div class="bomb" id="bomb">
          <!-- small glowing number on bomb -->
          <div style="font-weight:900;font-size:20px;color:#200;mix-blend-mode:screen;" id="bomb-display">üí£</div>
        </div>

        <div class="wires">
          <div class="wire"><div class="dot" style="background:#ff6b6b"></div>RED</div>
          <div class="wire"><div class="dot" style="background:#ffd166"></div>YELLOW</div>
          <div class="wire"><div class="dot" style="background:#22c1c3"></div>CYAN</div>
        </div>
      </div>

      <div class="card">
        <div class="question" id="question">Solve: 7 √ó 5 = ?</div>
        <div class="hint" id="hintText">Solve the equation to cut one wire. Faster = better!</div>

        <div class="pad" id="pad">
          <!-- keypad buttons generated by JS -->
        </div>

        <div class="answer" id="answer">Your answer: <span id="ansVal"></span></div>
      </div>

      <div class="overlay" id="overlay">
        <div class="msg" id="overlayMsg">
          <div class="boom" id="boomTitle" style="display:none">üí• BOOM! üí•</div>
          <div class="defused" id="defusedTitle" style="display:none">‚úÖ DEFUSED!</div>
          <div id="overlayText"></div>
          <div style="margin-top:12px"><button id="restartBtn" class="btn wide">Play Again</button></div>
        </div>
      </div>

      <!-- reflection layer for extra 3D feel -->
      <div style="position:absolute;left:0;right:0;top:0;height:100%;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,0.025),transparent 22%);border-radius:18px;mix-blend-mode:overlay"></div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   Game configuration
   ------------------------- */
const CONFIG = {
  initialTime: 30,     // seconds for first stage
  stages: 5,
  strikesAllowed: 3,
  timeDecayPerStage: 3,   // less time each stage
  difficultyIncrease: 1   // increases number size / operations
};

/* -------------------------
   State vars
   ------------------------- */
let state = {
  timeLeft: CONFIG.initialTime,
  stage: 1,
  strikes: 0,
  solvedStages: 0,
  paused: false,
  currentAnswer: '',
  currentSolution: null,
  timerInterval: null
};

/* -------------------------
   DOM elements
   ------------------------- */
const timerEl = document.getElementById('timer');
const questionEl = document.getElementById('question');
const padEl = document.getElementById('pad');
const ansValEl = document.getElementById('ansVal');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const boomTitle = document.getElementById('boomTitle');
const defusedTitle = document.getElementById('defusedTitle');
const restartBtn = document.getElementById('restartBtn');
const stageNum = document.getElementById('stage-num');
const strikesEl = document.getElementById('strikes');
const strikesMaxEl = document.getElementById('strikes-max');
const bombDisplay = document.getElementById('bomb-display');

/* -------------------------
   Audio setup (Web Audio)
   ------------------------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function beeper(f=880, t=0.08, type='sine', gain=0.08){
  if(!audioCtx) audioCtx = new AudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = f;
  g.gain.value = gain;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + t);
  setTimeout(()=>o.stop(), t*1000+50);
}
function alarmLoopStart(){
  // continuous low alarm tone
  if(!audioCtx) audioCtx = new AudioCtx();
  stopAlarm();
  window._alarmO = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  window._alarmO.type='sine';
  window._alarmO.frequency.value=220;
  g.gain.value=0.06;
  window._alarmO.connect(g); g.connect(audioCtx.destination);
  window._alarmGain = g;
  window._alarmO.start();
}
function stopAlarm(){ if(window._alarmO){ try{ window._alarmO.stop(); }catch(e){} window._alarmO=null; }}

/* -------------------------
   Helpers: timer formatting
   ------------------------- */
function fmtTime(s){
  s = Math.max(0, Math.floor(s));
  const mm = Math.floor(s/60);
  const ss = (s%60).toString().padStart(2,'0');
  return `${mm}:${ss}`;
}

/* -------------------------
   Equation generator
   returns {text, solution}
   ------------------------- */
function generateEquation(stage){
  // increase complexity with stage
  const difficulty = 1 + Math.floor((stage-1) * CONFIG.difficultyIncrease);
  const maxNum = 5 + difficulty * 5; // grows
  const ops = ['+','-','√ó','√∑','*']; // include √ó and √∑ visually
  // pick op weighted by stage (later includes multiplication/div)
  let availableOps = ['+','-'];
  if(stage>=2) availableOps.push('√ó');
  if(stage>=4) availableOps.push('√∑');

  const op = availableOps[Math.floor(Math.random()*availableOps.length)];
  let a = Math.floor(Math.random()*(maxNum-1))+1;
  let b = Math.floor(Math.random()*(maxNum-1))+1;

  // ensure integer division or nice decimals
  let solution, text;
  if(op === '√∑'){
    // make divisible occasionally or give 1-decimal answer
    if(Math.random() > 0.5){
      solution = a;
      b = Math.floor(Math.random()*(3))+1;
      a = solution * b;
    }
    solution = +(a / b).toFixed(2);
    text = `${a} √∑ ${b} = ?`;
  } else if(op === '√ó'){
    solution = a * b;
    text = `${a} √ó ${b} = ?`;
  } else if(op === '+'){
    solution = a + b;
    text = `${a} + ${b} = ?`;
  } else { // -
    // avoid negative too often
    if(b > a) [a,b] = [b,a];
    solution = a - b;
    text = `${a} ‚àí ${b} = ?`;
  }
  return {text, solution};
}

/* -------------------------
   UI: build keypad
   ------------------------- */
function buildPad(){
  padEl.innerHTML = '';
  const entries = [
    '7','8','9',
    '4','5','6',
    '1','2','3',
    '0','.','‚Üê',
    'Submit'
  ];
  entries.forEach(key=>{
    const btn = document.createElement('button');
    btn.className = 'btn' + (key==='Submit' ? ' wide' : '');
    btn.textContent = key;
    btn.addEventListener('click', ()=>onKey(key));
    padEl.appendChild(btn);
  });
}

/* -------------------------
   Key handling
   ------------------------- */
function onKey(key){
  if(state.paused) return;
  if(key === '‚Üê'){
    if(state.currentAnswer.length>0) state.currentAnswer = state.currentAnswer.slice(0,-1);
    updateAnswer();
    beeper(780,0.04, 'triangle', 0.02);
    return;
  }
  if(key === 'Submit'){
    submitAnswer();
    return;
  }
  // number or dot
  if(key === '.' && state.currentAnswer.includes('.')) return;
  state.currentAnswer += key;
  updateAnswer();
  beeper(880,0.05,'sine',0.03);
}
function updateAnswer(){
  ansValEl.textContent = state.currentAnswer || '‚Äî';
}

/* -------------------------
   Game flow
   ------------------------- */
function startStage(stage){
  state.stage = stage;
  stageNum.textContent = stage;
  state.currentAnswer = '';
  updateAnswer();
  const eq = generateEquation(stage);
  state.currentSolution = eq.solution;
  questionEl.textContent = eq.text;
  state.timeLeft = Math.max(6, CONFIG.initialTime - (stage-1)*CONFIG.timeDecayPerStage);
  updateTimerDisplay();
  startTimer();
  hiddenOverlay(false);
  strikesEl.textContent = state.strikes;
  bombPulse(true);
}

function startGame(){
  state.stage = 1;
  state.strikes = 0;
  state.solvedStages = 0;
  strikesEl.textContent = state.strikes;
  buildPad();
  startStage(1);
}

/* -------------------------
   Timer control
   ------------------------- */
function updateTimerDisplay(){
  timerEl.textContent = fmtTime(state.timeLeft);
  // color pulse when low
  const pct = state.timeLeft / CONFIG.initialTime;
  timerEl.style.color = pct <= 0.25 ? 'var(--accent)' : (pct <= 0.5 ? 'var(--accent2)' : 'var(--glow)');
}
function startTimer(){
  stopTimer();
  state.timerInterval = setInterval(()=>{
    if(state.paused) return;
    state.timeLeft -= 0.2;
    if(state.timeLeft <= 0){
      state.timeLeft = 0;
      updateTimerDisplay();
      stopTimer();
      detonate();
      return;
    }
    updateTimerDisplay();
    // beep tick faster as time runs out
    if(state.timeLeft < 6){
      beeper(640 + Math.random()*200, 0.03, 'sine', 0.02);
    }
  }, 200);
}
function stopTimer(){ if(state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }}

/* -------------------------
   Submit answer
   ------------------------- */
function submitAnswer(){
  if(state.currentAnswer === '') return;
  // compare numbers tolerant of decimals and strings
  let given = Number(state.currentAnswer);
  let expected = Number(state.currentSolution);
  const correct = Math.abs(given - expected) < 0.001;
  if(correct){
    // success
    beeper(1200,0.12,'sine',0.06);
    bombPulse(false);
    state.solvedStages++;
    stopTimer();
    if(state.stage >= CONFIG.stages){
      // finished all stages -> defused
      defuse();
    } else {
      // progress to next stage after short pause
      state.paused = true;
      overlayMsgShow('next','Stage cleared! Moving to next stage...');
      setTimeout(()=>{
        state.paused = false;
        startStage(state.stage + 1);
      }, 1200);
    }
  } else {
    // wrong -> strike, reduce time or add penalty
    beeper(240,0.22,'sawtooth',0.05);
    state.strikes++;
    strikesEl.textContent = state.strikes;
    state.timeLeft = Math.max(0, state.timeLeft - 6); // penalty
    // flash bomb red briefly
    flashBomb('red');
    if(state.strikes >= CONFIG.strikesAllowed){
      detonate();
    }
  }
}

/* -------------------------
   Explosion / Defuse
   ------------------------- */
function detonate(){
  stopTimer();
  bombPulse(false);
  // show boom overlay
  overlayMsgShow('boom','The bomb detonated. Better luck next time!');
  boomTitle.style.display = 'block';
  defusedTitle.style.display = 'none';
  playBoomAnimation();
  // loud alarm
  beeper(120,0.18,'square',0.12);
  alarmLoopStart();
}

function defuse(){
  stopTimer();
  bombPulse(false);
  overlayMsgShow('defused','You successfully defused the bomb. Phew!');
  boomTitle.style.display = 'none';
  defusedTitle.style.display = 'block';
  beeper(1200,0.18,'sine',0.08);
  stopAlarm();
}

/* -------------------------
   Overlay utilities
   ------------------------- */
function overlayMsgShow(mode, text){
  overlayText.textContent = text;
  overlay.classList.add('show');
  if(mode==='boom') overlay.classList.add('boom');
  restartBtn.focus();
}
restartBtn.addEventListener('click', ()=>{
  overlay.classList.remove('show');
  boomTitle.style.display = 'none';
  defusedTitle.style.display = 'none';
  stopAlarm();
  startGame();
});

/* -------------------------
   Bomb visuals
   ------------------------- */
function flashBomb(color){
  const orig = bombDisplay.style.filter || '';
  bombDisplay.style.transition = 'transform 0.12s ease, box-shadow 0.12s';
  bombDisplay.style.transform = 'scale(1.12)';
  if(color==='red') bombDisplay.style.textShadow = '0 6px 28px rgba(255,90,90,0.6)';
  setTimeout(()=>{ bombDisplay.style.transform=''; bombDisplay.style.textShadow=''; }, 220);
}
function bombPulse(on){
  if(on){
    bombDisplay.style.fontSize = '26px';
    bombDisplay.style.transition = 'box-shadow 0.3s';
    // subtle glow loop
    if(window._bombPulse) return;
    window._bombPulse = setInterval(()=>{
      bombDisplay.style.opacity = bombDisplay.style.opacity === '0.85' ? '1' : '0.85';
    }, 500);
  } else {
    if(window._bombPulse){ clearInterval(window._bombPulse); window._bombPulse = null; }
    bombDisplay.style.opacity = '1';
  }
}
function playBoomAnimation(){
  // quick "flash screen" red
  const el = document.body;
  const prev = el.style.background;
  let i=0;
  const iv = setInterval(()=>{
    el.style.background = `linear-gradient(180deg, rgba(255,80,80,${0.08 + i*0.02}), rgba(0,0,0,0.6))`;
    i++;
    if(i>6){ clearInterval(iv); el.style.background=''; }
  }, 90);
}


/* -------------------------
   Initialization
   ------------------------- */
buildPad();
startGame();

/* -------------------------
   Keyboard support for convenience
   ------------------------- */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') onKey('Submit');
  if(e.key === 'Backspace') onKey('‚Üê');
  if(/^[0-9]$/.test(e.key)) onKey(e.key);
  if(e.key === '.') onKey('.');
});
</script>
</body>
</html>
